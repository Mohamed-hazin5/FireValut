{"ast":null,"code":"import { AuthAction } from '@aws-amplify/core/internals/utils';\nimport { getUserContextData } from '../../../providers/cognito/utils/userContextData.mjs';\nimport { createInitiateAuthClient } from '../../../foundation/factories/serviceClients/cognitoIdentityProvider/createInitiateAuthClient.mjs';\nimport '@aws-amplify/core/internals/aws-client-utils/composers';\nimport '@aws-amplify/core/internals/aws-client-utils';\nimport '../../../foundation/factories/serviceClients/cognitoIdentityProvider/shared/handler/cognitoUserPoolTransferHandler.mjs';\nimport '../../../foundation/factories/serviceClients/cognitoIdentityProvider/constants.mjs';\nimport '../../../common/AuthErrorStrings.mjs';\nimport { AuthValidationErrorCode } from '../../../errors/types/validation.mjs';\nimport '../../../providers/cognito/types/errors.mjs';\nimport { createCognitoUserPoolEndpointResolver } from '../../../providers/cognito/factories/createCognitoUserPoolEndpointResolver.mjs';\nimport '@aws-amplify/core';\nimport { getRegionFromUserPoolId } from '../../../foundation/parsers/regionParsers.mjs';\nimport { getAuthUserAgentValue } from '../../../utils/getAuthUserAgentValue.mjs';\nimport { handlePasswordSRP } from '../shared/handlePasswordSRP.mjs';\nimport { assertValidationError } from '../../../errors/utils/assertValidationError.mjs';\nimport { setActiveSignInUsername } from '../../../providers/cognito/utils/setActiveSignInUsername.mjs';\n\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n/**\n * Handles user authentication flow with configurable challenge preferences.\n * Supports AuthFactorType challenges through the USER_AUTH flow.\n *\n * @param {HandleUserAuthFlowInput} params - Authentication flow parameters\n * @param {string} params.username - The username for authentication\n * @param {Record<string, string>} [params.clientMetadata] - Optional metadata to pass to authentication service\n * @param {CognitoUserPoolConfig} params.config - Cognito User Pool configuration\n * @param {AuthTokenOrchestrator} params.tokenOrchestrator - Manages authentication tokens and device tracking\n * @param {AuthFactorType} [params.preferredChallenge] - Optional preferred authentication method\n * @param {string} [params.password] - Required when preferredChallenge is 'PASSWORD' or 'PASSWORD_SRP'\n *\n * @returns {Promise<InitiateAuthCommandOutput>} The authentication response from Cognito\n */\nasync function handleUserAuthFlow({\n  username,\n  clientMetadata,\n  config,\n  tokenOrchestrator,\n  preferredChallenge,\n  password,\n  session\n}) {\n  const {\n    userPoolId,\n    userPoolClientId,\n    userPoolEndpoint\n  } = config;\n  const UserContextData = getUserContextData({\n    username,\n    userPoolId,\n    userPoolClientId\n  });\n  const authParameters = {\n    USERNAME: username\n  };\n  if (preferredChallenge) {\n    // Validate that the preferred challenge is enabled in the backend config\n    // Only validate if passwordless config exists (for backward compatibility)\n    if (config.passwordless) {\n      const isInvalidChallenge = preferredChallenge === 'EMAIL_OTP' && !config.passwordless.emailOtpEnabled || preferredChallenge === 'SMS_OTP' && !config.passwordless.smsOtpEnabled || preferredChallenge === 'WEB_AUTHN' && !config.passwordless.webAuthn;\n      if (isInvalidChallenge) {\n        assertValidationError(false, AuthValidationErrorCode.InvalidPreferredChallenge);\n      }\n    }\n    if (preferredChallenge === 'PASSWORD_SRP') {\n      assertValidationError(!!password, AuthValidationErrorCode.EmptySignInPassword);\n      return handlePasswordSRP({\n        username,\n        password,\n        clientMetadata,\n        config,\n        tokenOrchestrator,\n        authFlow: 'USER_AUTH',\n        preferredChallenge\n      });\n    }\n    if (preferredChallenge === 'PASSWORD') {\n      assertValidationError(!!password, AuthValidationErrorCode.EmptySignInPassword);\n      authParameters.PASSWORD = password;\n    }\n    authParameters.PREFERRED_CHALLENGE = preferredChallenge;\n  }\n  const jsonReq = {\n    AuthFlow: 'USER_AUTH',\n    AuthParameters: authParameters,\n    ClientMetadata: clientMetadata,\n    ClientId: userPoolClientId,\n    UserContextData\n  };\n  if (session) {\n    jsonReq.Session = session;\n  }\n  const initiateAuth = createInitiateAuthClient({\n    endpointResolver: createCognitoUserPoolEndpointResolver({\n      endpointOverride: userPoolEndpoint\n    })\n  });\n  const response = await initiateAuth({\n    region: getRegionFromUserPoolId(userPoolId),\n    userAgentValue: getAuthUserAgentValue(AuthAction.SignIn)\n  }, jsonReq);\n  // Set the active username immediately after successful authentication attempt\n  // If a user starts a new sign-in while another sign-in is incomplete,\n  // this ensures we're tracking the correct user for subsequent auth challenges.\n  setActiveSignInUsername(username);\n  return response;\n}\nexport { handleUserAuthFlow };","map":{"version":3,"names":["handleUserAuthFlow","username","clientMetadata","config","tokenOrchestrator","preferredChallenge","password","session","userPoolId","userPoolClientId","userPoolEndpoint","UserContextData","getUserContextData","authParameters","USERNAME","passwordless","isInvalidChallenge","emailOtpEnabled","smsOtpEnabled","webAuthn","assertValidationError","AuthValidationErrorCode","InvalidPreferredChallenge","EmptySignInPassword","handlePasswordSRP","authFlow","PASSWORD","PREFERRED_CHALLENGE","jsonReq","AuthFlow","AuthParameters","ClientMetadata","ClientId","Session","initiateAuth","createInitiateAuthClient","endpointResolver","createCognitoUserPoolEndpointResolver","endpointOverride","response","region","getRegionFromUserPoolId","userAgentValue","getAuthUserAgentValue","AuthAction","SignIn","setActiveSignInUsername"],"sources":["/Users/mohamedhazin/Desktop/filevalut/frontend/node_modules/@aws-amplify/auth/src/client/flows/userAuth/handleUserAuthFlow.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { AuthAction } from '@aws-amplify/core/internals/utils';\nimport { getUserContextData } from '../../../providers/cognito/utils/userContextData';\nimport { createInitiateAuthClient } from '../../../foundation/factories/serviceClients/cognitoIdentityProvider';\nimport { createCognitoUserPoolEndpointResolver } from '../../../providers/cognito/factories';\nimport { getRegionFromUserPoolId } from '../../../foundation/parsers';\nimport { getAuthUserAgentValue } from '../../../utils';\nimport { handlePasswordSRP } from '../shared/handlePasswordSRP';\nimport { assertValidationError } from '../../../errors/utils/assertValidationError';\nimport { AuthValidationErrorCode } from '../../../errors/types/validation';\nimport { setActiveSignInUsername } from '../../../providers/cognito/utils/setActiveSignInUsername';\n/**\n * Handles user authentication flow with configurable challenge preferences.\n * Supports AuthFactorType challenges through the USER_AUTH flow.\n *\n * @param {HandleUserAuthFlowInput} params - Authentication flow parameters\n * @param {string} params.username - The username for authentication\n * @param {Record<string, string>} [params.clientMetadata] - Optional metadata to pass to authentication service\n * @param {CognitoUserPoolConfig} params.config - Cognito User Pool configuration\n * @param {AuthTokenOrchestrator} params.tokenOrchestrator - Manages authentication tokens and device tracking\n * @param {AuthFactorType} [params.preferredChallenge] - Optional preferred authentication method\n * @param {string} [params.password] - Required when preferredChallenge is 'PASSWORD' or 'PASSWORD_SRP'\n *\n * @returns {Promise<InitiateAuthCommandOutput>} The authentication response from Cognito\n */\nexport async function handleUserAuthFlow({ username, clientMetadata, config, tokenOrchestrator, preferredChallenge, password, session, }) {\n    const { userPoolId, userPoolClientId, userPoolEndpoint } = config;\n    const UserContextData = getUserContextData({\n        username,\n        userPoolId,\n        userPoolClientId,\n    });\n    const authParameters = { USERNAME: username };\n    if (preferredChallenge) {\n        // Validate that the preferred challenge is enabled in the backend config\n        // Only validate if passwordless config exists (for backward compatibility)\n        if (config.passwordless) {\n            const isInvalidChallenge = (preferredChallenge === 'EMAIL_OTP' &&\n                !config.passwordless.emailOtpEnabled) ||\n                (preferredChallenge === 'SMS_OTP' &&\n                    !config.passwordless.smsOtpEnabled) ||\n                (preferredChallenge === 'WEB_AUTHN' && !config.passwordless.webAuthn);\n            if (isInvalidChallenge) {\n                assertValidationError(false, AuthValidationErrorCode.InvalidPreferredChallenge);\n            }\n        }\n        if (preferredChallenge === 'PASSWORD_SRP') {\n            assertValidationError(!!password, AuthValidationErrorCode.EmptySignInPassword);\n            return handlePasswordSRP({\n                username,\n                password,\n                clientMetadata,\n                config,\n                tokenOrchestrator,\n                authFlow: 'USER_AUTH',\n                preferredChallenge,\n            });\n        }\n        if (preferredChallenge === 'PASSWORD') {\n            assertValidationError(!!password, AuthValidationErrorCode.EmptySignInPassword);\n            authParameters.PASSWORD = password;\n        }\n        authParameters.PREFERRED_CHALLENGE = preferredChallenge;\n    }\n    const jsonReq = {\n        AuthFlow: 'USER_AUTH',\n        AuthParameters: authParameters,\n        ClientMetadata: clientMetadata,\n        ClientId: userPoolClientId,\n        UserContextData,\n    };\n    if (session) {\n        jsonReq.Session = session;\n    }\n    const initiateAuth = createInitiateAuthClient({\n        endpointResolver: createCognitoUserPoolEndpointResolver({\n            endpointOverride: userPoolEndpoint,\n        }),\n    });\n    const response = await initiateAuth({\n        region: getRegionFromUserPoolId(userPoolId),\n        userAgentValue: getAuthUserAgentValue(AuthAction.SignIn),\n    }, jsonReq);\n    // Set the active username immediately after successful authentication attempt\n    // If a user starts a new sign-in while another sign-in is incomplete,\n    // this ensures we're tracking the correct user for subsequent auth challenges.\n    setActiveSignInUsername(username);\n    return response;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AACA;AAWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,eAAeA,kBAAkBA,CAAC;EAAEC,QAAQ;EAAEC,cAAc;EAAEC,MAAM;EAAEC,iBAAiB;EAAEC,kBAAkB;EAAEC,QAAQ;EAAEC;AAAO,CAAG,EAAE;EACtI,MAAM;IAAEC,UAAU;IAAEC,gBAAgB;IAAEC;EAAgB,CAAE,GAAGP,MAAM;EACjE,MAAMQ,eAAe,GAAGC,kBAAkB,CAAC;IACvCX,QAAQ;IACRO,UAAU;IACVC;EACR,CAAK,CAAC;EACF,MAAMI,cAAc,GAAG;IAAEC,QAAQ,EAAEb;EAAQ,CAAE;EAC7C,IAAII,kBAAkB,EAAE;IAC5B;IACA;IACQ,IAAIF,MAAM,CAACY,YAAY,EAAE;MACrB,MAAMC,kBAAkB,GAAIX,kBAAkB,KAAK,WAAW,IAC1D,CAACF,MAAM,CAACY,YAAY,CAACE,eAAe,IACnCZ,kBAAkB,KAAK,SAAS,IAC7B,CAACF,MAAM,CAACY,YAAY,CAACG,aAAc,IACtCb,kBAAkB,KAAK,WAAW,IAAI,CAACF,MAAM,CAACY,YAAY,CAACI,QAAS;MACzE,IAAIH,kBAAkB,EAAE;QACpBI,qBAAqB,CAAC,KAAK,EAAEC,uBAAuB,CAACC,yBAAyB,CAAC;MACnF;IACJ;IACA,IAAIjB,kBAAkB,KAAK,cAAc,EAAE;MACvCe,qBAAqB,CAAC,CAAC,CAACd,QAAQ,EAAEe,uBAAuB,CAACE,mBAAmB,CAAC;MAC9E,OAAOC,iBAAiB,CAAC;QACrBvB,QAAQ;QACRK,QAAQ;QACRJ,cAAc;QACdC,MAAM;QACNC,iBAAiB;QACjBqB,QAAQ,EAAE,WAAW;QACrBpB;MAChB,CAAa,CAAC;IACN;IACA,IAAIA,kBAAkB,KAAK,UAAU,EAAE;MACnCe,qBAAqB,CAAC,CAAC,CAACd,QAAQ,EAAEe,uBAAuB,CAACE,mBAAmB,CAAC;MAC9EV,cAAc,CAACa,QAAQ,GAAGpB,QAAQ;IACtC;IACAO,cAAc,CAACc,mBAAmB,GAAGtB,kBAAkB;EAC3D;EACA,MAAMuB,OAAO,GAAG;IACZC,QAAQ,EAAE,WAAW;IACrBC,cAAc,EAAEjB,cAAc;IAC9BkB,cAAc,EAAE7B,cAAc;IAC9B8B,QAAQ,EAAEvB,gBAAgB;IAC1BE;EACR,CAAK;EACD,IAAIJ,OAAO,EAAE;IACTqB,OAAO,CAACK,OAAO,GAAG1B,OAAO;EAC7B;EACA,MAAM2B,YAAY,GAAGC,wBAAwB,CAAC;IAC1CC,gBAAgB,EAAEC,qCAAqC,CAAC;MACpDC,gBAAgB,EAAE5B;IAC9B,CAAS;EACT,CAAK,CAAC;EACF,MAAM6B,QAAQ,GAAG,MAAML,YAAY,CAAC;IAChCM,MAAM,EAAEC,uBAAuB,CAACjC,UAAU,CAAC;IAC3CkC,cAAc,EAAEC,qBAAqB,CAACC,UAAU,CAACC,MAAM;EAC/D,CAAK,EAAEjB,OAAO,CAAC;EACf;EACA;EACA;EACIkB,uBAAuB,CAAC7C,QAAQ,CAAC;EACjC,OAAOsC,QAAQ;AACnB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}